-- psql
-- Before anything, let's check if internal role linking/delinking worked as expected
SELECT r.rolname AS parent_role
FROM pg_auth_members m
JOIN pg_roles r ON (m.roleid = r.oid)
JOIN pg_roles mr ON (m.member = mr.oid)
WHERE mr.rolname = 'dbowner__main_db_dbowner__u1_obj'
ORDER BY r.rolname;
go
~~START~~
name
~~END~~


SELECT r.rolname AS parent_role
FROM pg_auth_members m
JOIN pg_roles r ON (m.roleid = r.oid)
JOIN pg_roles mr ON (m.member = mr.oid)
WHERE mr.rolname = 'dbowner__main_db_dbowner__u1'
ORDER BY r.rolname;
go
~~START~~
name
dbowner__main_db_db_owner
dbowner__main_db_dbo
dbowner__main_db_dbowner__u1_obj
~~END~~


SELECT r.rolname AS parent_role
FROM pg_auth_members m
JOIN pg_roles r ON (m.roleid = r.oid)
JOIN pg_roles mr ON (m.member = mr.oid)
WHERE mr.rolname = 'dbowner__main_db_db_owner'
ORDER BY r.rolname;
go
~~START~~
name
dbowner__main_db_db_accessadmin
dbowner__main_db_db_datareader
dbowner__main_db_db_datawriter
dbowner__main_db_db_ddladmin
dbowner__main_db_db_securityadmin
dbowner__main_db_dbowner__r1
dbowner__main_db_dbowner__r2
dbowner__main_db_dbowner__u1_obj
dbowner__main_db_dbowner__u2
dbowner__main_db_guest
~~END~~


SELECT r.rolname AS parent_role
FROM pg_auth_members m
JOIN pg_roles r ON (m.roleid = r.oid)
JOIN pg_roles mr ON (m.member = mr.oid)
WHERE mr.rolname = 'dbowner__main_db_dbo'
ORDER BY r.rolname;
go
~~START~~
name
dbowner__main_db_db_owner
~~END~~


-- tsql
alter login dbowner__l1 with password = '123'
go
alter login dbowner__l2 with password = '123'
go
alter login dbowner__temp with password = '123'
go

-- Adding/Dropping non-existent user to db_owner should throw error
alter role db_owner add member a_very_invalid_username
go
~~ERROR (Code: 33557097)~~

~~ERROR (Message: role "master_a_very_invalid_username" does not exist)~~

alter role db_owner drop member a_very_invalid_username
go
~~ERROR (Code: 33557097)~~

~~ERROR (Message: role "master_a_very_invalid_username" does not exist)~~


-- tsql user=dbowner__l1 password=123
-- CASE 0: Should not be able to manipulate server level objects
use dbowner__main_db
go
select is_member('db_owner')
go
~~START~~
int
1
~~END~~

create database dbowner_try_db_create
go
~~ERROR (Code: 33557097)~~

~~ERROR (Message: permission denied to create database)~~

create login dbowner_try_login_create with password = '123'
go
~~ERROR (Code: 33557097)~~

~~ERROR (Message: Current login dbowner__l1 does not have permission to create new login)~~

drop login dbowner__l1
go
~~ERROR (Code: 33557097)~~

~~ERROR (Message: Cannot drop the login 'dbowner__l1', because it does not exist or you do not have permission.)~~

drop login dbowner__l2
go
~~ERROR (Code: 33557097)~~

~~ERROR (Message: Cannot drop the login 'dbowner__l2', because it does not exist or you do not have permission.)~~

alter server role sysadmin add member dbowner__temp
go
~~ERROR (Code: 33557097)~~

~~ERROR (Message: Current login dbowner__l1 does not have permission to alter server role)~~


-- CASE 1: Able to access all objects in its own database
select is_member('db_owner')
go
~~START~~
int
1
~~END~~

insert into dbo.dbowner__t0 values (10), (20), (30)
go
~~START~~
varchar
New row inserted
~~END~~

~~ROW COUNT: 3~~

select * from dbo.dbowner__t0
go
~~START~~
int
10
20
30
~~END~~

select * from dbo.dbowner__v0
go
~~START~~
int
1
~~END~~

select next value for dbo.dbowner__seq0;
go
~~START~~
bigint
2
~~END~~

select dbo.dbowner__f0()
go
~~START~~
int
10
~~END~~

exec dbo.dbowner__p0
go
~~START~~
int
20
~~END~~

insert into dbowner__s1.dbowner__t1 values (11), (21), (31)
go
~~START~~
varchar
New row inserted
~~END~~

~~ROW COUNT: 3~~

select * from dbowner__s1.dbowner__t1
go
~~START~~
int
11
21
31
~~END~~

select * from dbowner__s1.dbowner__v1
go
~~START~~
int
1
~~END~~

select next value for dbowner__s1.dbowner__seq1;
go
~~START~~
bigint
3
~~END~~

select dbowner__s1.dbowner__f1()
go
~~START~~
int
11
~~END~~

exec dbowner__s1.dbowner__p1
go
~~START~~
int
21
~~END~~

insert into dbowner__s2.dbowner__t2 values (12), (22), (32)
go
~~START~~
varchar
New row inserted
~~END~~

~~ROW COUNT: 3~~

select * from dbowner__s2.dbowner__t2
go
~~START~~
int
12
22
32
~~END~~

select * from dbowner__s2.dbowner__v2
go
~~START~~
int
1
~~END~~

select next value for dbowner__s2.dbowner__seq2;
go
~~START~~
bigint
4
~~END~~

select dbowner__s2.dbowner__f2()
go
~~START~~
int
12
~~END~~

exec dbowner__s2.dbowner__p2
go
~~START~~
int
22
~~END~~


-- CASE 2: Able to perform DDL on objects in its own database
create table dbowner__s1.dbowner__t11 (a dbowner__s1.dbowner__typ1)
go
create schema dbowner__s3 authorization dbowner__u1
go
create schema dbowner__sch_u2 authorization dbowner__u2
go
create type dbowner__s3.dbowner__typ3 from int
go
create table dbowner__s3.dbowner__t3 (a dbowner__s3.dbowner__typ3)
go
create function dbowner__s3.dbowner__f3() returns int as begin return 13 end
go
create procedure dbowner__s3.dbowner__p3 as select 23
go
create view dbowner__s3.dbowner__v3 as select 230
go
create sequence dbowner__s3.dbowner__seq3 as int start with 5 increment by 5;
go
alter table dbo.dbowner__t0 add b int
go
alter function dbo.dbowner__f0() returns int as begin return 134 end
go
alter procedure dbo.dbowner__p0 as select 234
go
alter table dbo.dbowner__t0 drop column b
go
alter function dbo.dbowner__f0() returns int as begin return 10 end
go
alter procedure dbo.dbowner__p0 as select 20
go

-- BABEL-5417: Trigger gets dropped if we drop a column in table
create trigger dbo.dbowner__trg0
on dbo.dbowner__t0
after insert
as
begin
    select 'New row inserted'
end
go

-- Member of db_owner role should be allowed to rename objects
exec sp_rename 'dbo.dbowner__t0.x', 'x_renamed', 'column'
go
exec sp_rename 'dbo.dbowner__typ0', 'dbowner__typ0_renamed', 'userdatatype'
go
exec sp_rename 'dbo.dbowner__t0', 'dbowner__t0_renamed', 'object'
go
exec sp_rename 'dbo.dbowner__p0', 'dbowner__p0_renamed', 'object'
go
exec sp_rename 'dbo.dbowner__f0', 'dbowner__f0_renamed', 'object'
go
exec sp_rename 'dbo.dbowner__v0', 'dbowner__v0_renamed', 'object'
go
exec sp_rename 'dbowner__trg0', 'dbowner__trg0_renamed', 'object'
go
exec sp_rename 'dbo.dbowner__seq0', 'dbowner__seq0_renamed', 'object'
go

-- psql
-- Procedure/function owners should be dbowner__main_db_dbo
SELECT proname,
       proowner::regrole
FROM pg_proc
WHERE pronamespace::regnamespace::text = 'dbowner__main_db_dbo'
AND proname LIKE 'dbowner__%'
ORDER BY proname;
GO
~~START~~
name#!#regrole
dbowner__f0_renamed#!#dbowner__main_db_dbo
dbowner__p0_renamed#!#dbowner__main_db_dbo
dbowner__trg0_renamed#!#dbowner__main_db_dbo
~~END~~


-- Object owners should be dbowner__main_db_dbo
SELECT
    n.nspname AS schema,
    c.relname AS table,
    CASE c.relkind
        WHEN 'r' THEN 'table'
        WHEN 'v' THEN 'view'
        WHEN 'm' THEN 'materialized view'
        WHEN 'i' THEN 'index'
        WHEN 'S' THEN 'sequence'
        WHEN 's' THEN 'special'
        WHEN 'f' THEN 'foreign table'
    END AS type,
    pg_catalog.pg_get_userbyid(c.relowner) AS owner
FROM pg_catalog.pg_class c
LEFT JOIN pg_catalog.pg_namespace n ON n.oid = c.relnamespace
WHERE n.nspname = 'dbowner__main_db_dbo'
AND c.relname LIKE 'dbowner__%'
AND c.relkind IN ('r', 'v', 'm', 'i', 'S', 's', 'f')
ORDER BY n.nspname, c.relkind, c.relname;
GO
~~START~~
name#!#name#!#text#!#name
dbowner__main_db_dbo#!#dbowner__seq0_renamed#!#sequence#!#dbowner__main_db_dbo
dbowner__main_db_dbo#!#dbowner__idx0dbowner__t09cffe6f70730964de614f2e351e0e1bf#!#index#!#dbowner__main_db_dbo
dbowner__main_db_dbo#!#dbowner__t0_renamed#!#table#!#dbowner__main_db_dbo
dbowner__main_db_dbo#!#dbowner__v0_renamed#!#view#!#dbowner__main_db_dbo
~~END~~


-- tsql user=dbowner__l1 password=123
exec sp_rename 'dbo.dbowner__t0_renamed', 'dbowner__t0', 'object'
go
exec sp_rename 'dbo.dbowner__t0.x_renamed', 'x', 'column'
go
exec sp_rename 'dbo.dbowner__typ0_renamed', 'dbowner__typ0', 'userdatatype'
go
exec sp_rename 'dbo.dbowner__p0_renamed', 'dbowner__p0', 'object'
go
exec sp_rename 'dbo.dbowner__f0_renamed', 'dbowner__f0', 'object'
go
exec sp_rename 'dbo.dbowner__v0_renamed', 'dbowner__v0', 'object'
go
exec sp_rename 'dbowner__trg0_renamed', 'dbowner__trg0', 'object'
go
exec sp_rename 'dbo.dbowner__seq0_renamed', 'dbowner__seq0', 'object'
go

exec sp_rename 'dbowner__s1.dbowner__t1.a', 'a_renamed', 'column'
go
exec sp_rename 'dbowner__s1.dbowner__typ1', 'dbowner__typ1_renamed', 'userdatatype'
go
exec sp_rename 'dbowner__s1.dbowner__t1', 'dbowner__t1_renamed', 'object'
go
exec sp_rename 'dbowner__s1.dbowner__p1', 'dbowner__p1_renamed', 'object'
go
exec sp_rename 'dbowner__s1.dbowner__f1', 'dbowner__f1_renamed', 'object'
go
exec sp_rename 'dbowner__s1.dbowner__v1', 'dbowner__v1_renamed', 'object'
go
exec sp_rename 'dbowner__s1.dbowner__trg1', 'dbowner__trg1_renamed', 'object'
go
exec sp_rename 'dbowner__s1.dbowner__seq1', 'dbowner__seq1_renamed', 'object'
go

exec sp_rename 'dbowner__s3.dbowner__t3.a', 'a_renamed', 'column'
go
exec sp_rename 'dbowner__s3.dbowner__typ3', 'dbowner__typ3_renamed', 'userdatatype'
go
exec sp_rename 'dbowner__s3.dbowner__t3', 'dbowner__t3_renamed', 'object'
go
exec sp_rename 'dbowner__s3.dbowner__p3', 'dbowner__p3_renamed', 'object'
go
exec sp_rename 'dbowner__s3.dbowner__f3', 'dbowner__f3_renamed', 'object'
go
exec sp_rename 'dbowner__s3.dbowner__v3', 'dbowner__v3_renamed', 'object'
go
exec sp_rename 'dbowner__s3.dbowner__seq3', 'dbowner__seq3_renamed', 'object'
go

-- psql
-- Procedure/function owners should be dbowner__main_db_dbowner__u1_obj
SELECT proname,
       proowner::regrole
FROM pg_proc
WHERE pronamespace::regnamespace::text = 'dbowner__main_db_dbowner__s1'
OR pronamespace::regnamespace::text = 'dbowner__main_db_dbowner__s3'
ORDER BY proname;
GO
~~START~~
name#!#regrole
dbowner__f1_renamed#!#dbowner__main_db_dbowner__u1_obj
dbowner__f3_renamed#!#dbowner__main_db_dbowner__u1_obj
dbowner__p1_renamed#!#dbowner__main_db_dbowner__u1_obj
dbowner__p3_renamed#!#dbowner__main_db_dbowner__u1_obj
dbowner__trg1_renamed#!#dbowner__main_db_dbowner__u1_obj
~~END~~


-- Table owners should be dbowner__main_db_dbowner__u1_obj
SELECT
    n.nspname AS schema,
    c.relname AS table,
    CASE c.relkind
        WHEN 'r' THEN 'table'
        WHEN 'v' THEN 'view'
        WHEN 'm' THEN 'materialized view'
        WHEN 'i' THEN 'index'
        WHEN 'S' THEN 'sequence'
        WHEN 's' THEN 'special'
        WHEN 'f' THEN 'foreign table'
    END AS type,
    pg_catalog.pg_get_userbyid(c.relowner) AS owner
FROM pg_catalog.pg_class c
LEFT JOIN pg_catalog.pg_namespace n ON n.oid = c.relnamespace
WHERE (n.nspname = 'dbowner__main_db_dbowner__s1' OR n.nspname = 'dbowner__main_db_dbowner__s3')
AND c.relkind IN ('r', 'v', 'm', 'i', 'S', 's', 'f')
ORDER BY n.nspname, c.relkind, c.relname;
GO
~~START~~
name#!#name#!#text#!#name
dbowner__main_db_dbowner__s1#!#dbowner__seq1_renamed#!#sequence#!#dbowner__main_db_dbowner__u1_obj
dbowner__main_db_dbowner__s1#!#dbowner__idx1dbowner__t1051d92a6c0688536803636483cfc1e78#!#index#!#dbowner__main_db_dbowner__u1_obj
dbowner__main_db_dbowner__s1#!#dbowner__t11#!#table#!#dbowner__main_db_dbowner__u1_obj
dbowner__main_db_dbowner__s1#!#dbowner__t1_renamed#!#table#!#dbowner__main_db_dbowner__u1_obj
dbowner__main_db_dbowner__s1#!#dbowner__v1_renamed#!#view#!#dbowner__main_db_dbowner__u1_obj
dbowner__main_db_dbowner__s3#!#dbowner__seq3_renamed#!#sequence#!#dbowner__main_db_dbowner__u1_obj
dbowner__main_db_dbowner__s3#!#dbowner__t3_renamed#!#table#!#dbowner__main_db_dbowner__u1_obj
dbowner__main_db_dbowner__s3#!#dbowner__v3_renamed#!#view#!#dbowner__main_db_dbowner__u1_obj
~~END~~


-- tsql user=dbowner__l1 password=123
exec sp_rename 'dbowner__s1.dbowner__t1_renamed', 'dbowner__t1', 'object'
go
exec sp_rename 'dbowner__s1.dbowner__t1.a_renamed', 'a', 'column'
go
exec sp_rename 'dbowner__s1.dbowner__typ1_renamed', 'dbowner__typ1', 'userdatatype'
go
exec sp_rename 'dbowner__s1.dbowner__p1_renamed', 'dbowner__p1', 'object'
go
exec sp_rename 'dbowner__s1.dbowner__f1_renamed', 'dbowner__f1', 'object'
go
exec sp_rename 'dbowner__s1.dbowner__v1_renamed', 'dbowner__v1', 'object'
go
exec sp_rename 'dbowner__s1.dbowner__trg1_renamed', 'dbowner__trg1', 'object'
go
exec sp_rename 'dbowner__s1.dbowner__seq1_renamed', 'dbowner__seq1', 'object'
go

exec sp_rename 'dbowner__s3.dbowner__t3_renamed', 'dbowner__t3', 'object'
go
exec sp_rename 'dbowner__s3.dbowner__t3.a_renamed', 'a', 'column'
go
exec sp_rename 'dbowner__s3.dbowner__typ3_renamed', 'dbowner__typ3', 'userdatatype'
go
exec sp_rename 'dbowner__s3.dbowner__p3_renamed', 'dbowner__p3', 'object'
go
exec sp_rename 'dbowner__s3.dbowner__f3_renamed', 'dbowner__f3', 'object'
go
exec sp_rename 'dbowner__s3.dbowner__v3_renamed', 'dbowner__v3', 'object'
go
exec sp_rename 'dbowner__s3.dbowner__seq3_renamed', 'dbowner__seq3', 'object'
go

exec sp_rename 'dbowner__s2.dbowner__t2.a', 'a_renamed', 'column'
go
exec sp_rename 'dbowner__s2.dbowner__typ2', 'dbowner__typ2_renamed', 'userdatatype'
go
exec sp_rename 'dbowner__s2.dbowner__t2', 'dbowner__t2_renamed', 'object'
go
exec sp_rename 'dbowner__s2.dbowner__p2', 'dbowner__p2_renamed', 'object'
go
exec sp_rename 'dbowner__s2.dbowner__f2', 'dbowner__f2_renamed', 'object'
go
exec sp_rename 'dbowner__s2.dbowner__v2', 'dbowner__v2_renamed', 'object'
go
exec sp_rename 'dbowner__s2.dbowner__seq2', 'dbowner__seq2_renamed', 'object'
go

-- psql
-- Procedure/function owners should be dbowner__main_db_dbowner__u2
SELECT proname,
       proowner::regrole
FROM pg_proc
WHERE pronamespace::regnamespace::text = 'dbowner__main_db_dbowner__s2'
ORDER BY proname;
GO
~~START~~
name#!#regrole
dbowner__f2_renamed#!#dbowner__main_db_dbowner__u2
dbowner__p2_renamed#!#dbowner__main_db_dbowner__u2
dbowner__trg2#!#dbowner__main_db_dbowner__u2
~~END~~


-- Table owners should be dbowner__main_db_dbowner__u2
SELECT
    n.nspname AS schema,
    c.relname AS table,
    CASE c.relkind
        WHEN 'r' THEN 'table'
        WHEN 'v' THEN 'view'
        WHEN 'm' THEN 'materialized view'
        WHEN 'i' THEN 'index'
        WHEN 'S' THEN 'sequence'
        WHEN 's' THEN 'special'
        WHEN 'f' THEN 'foreign table'
    END AS type,
    pg_catalog.pg_get_userbyid(c.relowner) AS owner
FROM pg_catalog.pg_class c
LEFT JOIN pg_catalog.pg_namespace n ON n.oid = c.relnamespace
WHERE n.nspname = 'dbowner__main_db_dbowner__s2'
AND c.relkind IN ('r', 'v', 'm', 'i', 'S', 's', 'f')
ORDER BY n.nspname, c.relkind, c.relname;
GO
~~START~~
name#!#name#!#text#!#name
dbowner__main_db_dbowner__s2#!#dbowner__seq2_renamed#!#sequence#!#dbowner__main_db_dbowner__u2
dbowner__main_db_dbowner__s2#!#dbowner__idx2dbowner__t29e647ba0aded42e8e308d42ed0d51945#!#index#!#dbowner__main_db_dbowner__u2
dbowner__main_db_dbowner__s2#!#dbowner__t2_renamed#!#table#!#dbowner__main_db_dbowner__u2
dbowner__main_db_dbowner__s2#!#dbowner__v2_renamed#!#view#!#dbowner__main_db_dbowner__u2
~~END~~


-- tsql user=dbowner__l1 password=123
exec sp_rename 'dbowner__s2.dbowner__t2_renamed', 'dbowner__t2', 'object'
go
exec sp_rename 'dbowner__s2.dbowner__t2.a_renamed', 'a', 'column'
go
exec sp_rename 'dbowner__s2.dbowner__typ2_renamed', 'dbowner__typ2', 'userdatatype'
go
exec sp_rename 'dbowner__s2.dbowner__p2_renamed', 'dbowner__p2', 'object'
go
exec sp_rename 'dbowner__s2.dbowner__f2_renamed', 'dbowner__f2', 'object'
go
exec sp_rename 'dbowner__s2.dbowner__v2_renamed', 'dbowner__v2', 'object'
go
exec sp_rename 'dbowner__s2.dbowner__seq2_renamed', 'dbowner__seq2', 'object'
go

-- CASE 3: Able to GRANT/REVOKE on SCHEMA/OBJECT
grant select on schema::dbowner__s1 to dbowner__u2
go
grant insert on schema::dbowner__s2 to guest
go
grant update on schema::dbowner__s3 to dbowner__u2
go
grant delete on schema::dbo to dbowner__u2
go
grant select on object::dbo.dbowner__t0 to dbowner__u2
go
grant insert on object::dbowner__s1.dbowner__t1 to dbowner__u2
go
grant update on object::dbowner__s2.dbowner__t2 to dbowner__u1
go
grant delete on object::dbowner__s3.dbowner__t3 to dbowner__u2
go
grant execute on object::dbowner__s1.dbowner__f1 to dbowner__u1
go
grant execute on object::dbowner__s3.dbowner__p3 to dbowner__u1
go

-- psql
select schema_name, object_name, permission, grantee, grantor from sys.babelfish_schema_permissions
where grantee IN ('dbowner__main_db_guest', 'dbowner__main_db_dbowner__u1', 'dbowner__main_db_dbowner__u2') order by permission;
GO
~~START~~
"sys"."varchar"#!#"sys"."varchar"#!#int4#!#"sys"."varchar"#!#"sys"."varchar"
dbowner__s1#!#dbowner__t1#!#1#!#dbowner__main_db_dbowner__u2#!#<NULL>
dbowner__s2#!#ALL#!#1#!#dbowner__main_db_guest#!#<NULL>
dbowner__s1#!#ALL#!#2#!#dbowner__main_db_dbowner__u2#!#<NULL>
dbo#!#dbowner__t0#!#2#!#dbowner__main_db_dbowner__u2#!#<NULL>
dbowner__s3#!#ALL#!#4#!#dbowner__main_db_dbowner__u2#!#<NULL>
dbowner__s2#!#dbowner__t2#!#4#!#dbowner__main_db_dbowner__u1#!#<NULL>
dbowner__s3#!#dbowner__t3#!#8#!#dbowner__main_db_dbowner__u2#!#<NULL>
dbo#!#ALL#!#8#!#dbowner__main_db_dbowner__u2#!#<NULL>
dbowner__s3#!#dbowner__p3#!#128#!#dbowner__main_db_dbowner__u1#!#<NULL>
dbowner__s1#!#dbowner__f1#!#128#!#dbowner__main_db_dbowner__u1#!#<NULL>
~~END~~


-- tsql user=dbowner__l1 password=123
revoke select on schema::dbowner__s1 to dbowner__u2
go
revoke insert on schema::dbowner__s2 to guest
go
revoke update on schema::dbowner__s3 to dbowner__u2
go
revoke delete on schema::dbo to dbowner__u2
go
revoke select on object::dbo.dbowner__t0 to dbowner__u2
go
revoke insert on object::dbowner__s1.dbowner__t1 to dbowner__u2
go
revoke update on object::dbowner__s2.dbowner__t2 to dbowner__u1
go
revoke delete on object::dbowner__s3.dbowner__t3 to dbowner__u2
go
revoke execute on object::dbowner__s1.dbowner__f1 to dbowner__u1
go
revoke execute on object::dbowner__s3.dbowner__p3 to dbowner__u1
go

-- tsql
-- Adding a member to db_owner role should not affect other user's privileges
use dbowner__main_db
go
alter role db_owner drop member dbowner__u1
go
grant select on schema::dbowner__s0 to dbowner__u2
go
alter role db_owner add member dbowner__u1
go
grant execute on schema::dbowner__s0 to dbowner__u2
go

-- tsql user=dbowner__l2 password=123
-- GRANT on dbowner__u2 should allow it to still access objects in schema
use dbowner__main_db
go
select * from dbowner__s0.dbowner__t00
go
~~START~~
float
~~END~~

select * from dbowner__s0.dbowner__v00
go
~~START~~
int
1
~~END~~

select dbowner__s0.dbowner__f00()
go
~~START~~
int
987
~~END~~


-- tsql
revoke select on schema::dbowner__s0 to dbowner__u2
go
revoke execute on schema::dbowner__s0 to dbowner__u2
go

-- psql
select schema_name, object_name, permission, grantee, grantor from sys.babelfish_schema_permissions
where grantee IN ('dbowner__main_db_guest', 'dbowner__main_db_dbowner__u1', 'dbowner__main_db_dbowner__u2') order by permission;
GO
~~START~~
"sys"."varchar"#!#"sys"."varchar"#!#int4#!#"sys"."varchar"#!#"sys"."varchar"
~~END~~


-- tsql user=dbowner__l1 password=123
-- CASE 4: Able to ALTER ANY USER
select rolname, login_name, default_schema_name, default_language_name from babelfish_authid_user_ext where rolname in ('dbowner__main_db_dbowner__u1', 'dbowner__main_db_new_dbowner__u2') order by rolname
go
~~START~~
varchar#!#varchar#!#nvarchar#!#nvarchar
dbowner__main_db_dbowner__u1#!#dbowner__l1#!#dbo#!#English
~~END~~

alter user dbowner__u1 with default_schema = dbowner__s1
go
alter user dbowner__u2 with default_schema = dbo
go
alter user dbowner__u2 with login = dbowner__temp
go
alter user dbowner__u2 with name = new_dbowner__u2
go
select rolname, login_name, default_schema_name, default_language_name from babelfish_authid_user_ext where rolname in ('dbowner__main_db_dbowner__u1', 'dbowner__main_db_new_dbowner__u2') order by rolname
go
~~START~~
varchar#!#varchar#!#nvarchar#!#nvarchar
dbowner__main_db_dbowner__u1#!#dbowner__l1#!#dbowner__s1#!#English
dbowner__main_db_new_dbowner__u2#!#dbowner__temp#!#dbo#!#English
~~END~~

select sys.user_name(), sys.suser_name(), is_member('db_owner')
go
~~START~~
nvarchar#!#nvarchar#!#int
dbowner__u1#!#dbowner__l1#!#1
~~END~~

alter user new_dbowner__u2 with default_schema = dbo
go
alter user new_dbowner__u2 with login = dbowner__l2
go
alter user new_dbowner__u2 with name = dbowner__u2
go
alter user dbowner__u1 with login = dbowner__temp
go
select sys.user_name(), sys.suser_name(), is_member('db_owner')
go
~~START~~
nvarchar#!#nvarchar#!#int
guest#!#dbowner__l1#!#0
~~END~~

select rolname, login_name, default_schema_name, default_language_name from babelfish_authid_user_ext where rolname in ('dbowner__main_db_dbowner__u1', 'dbowner__main_db_new_dbowner__u2') order by rolname
go
~~START~~
varchar#!#varchar#!#nvarchar#!#nvarchar
dbowner__main_db_dbowner__u1#!#dbowner__temp#!#dbowner__s1#!#English
~~END~~

alter user dbowner__u1 with login = dbowner__l1
go
~~ERROR (Code: 33557097)~~

~~ERROR (Message: Current user does not have privileges to change login)~~

select rolname, login_name, default_schema_name, default_language_name from babelfish_authid_user_ext where rolname in ('dbowner__main_db_dbowner__u1', 'dbowner__main_db_new_dbowner__u2') order by rolname
go
~~START~~
varchar#!#varchar#!#nvarchar#!#nvarchar
dbowner__main_db_dbowner__u1#!#dbowner__temp#!#dbowner__s1#!#English
~~END~~

select name from sys.database_principals order by name
go
~~START~~
varchar
db_accessadmin
db_datareader
db_datawriter
db_ddladmin
db_owner
db_securityadmin
dbo
guest
INFORMATION_SCHEMA
public
sys
~~END~~


-- tsql
use dbowner__main_db
go
exec sp_droprolemember 'db_owner', 'dbowner__u1'
go
exec sp_addrolemember 'db_owner', 'dbowner__u1'
go
alter user dbowner__u1 with login = dbowner__l1
go

-- terminate-tsql-conn user=dbowner__l1 password=123

-- tsql user=dbowner__l1 password=123
use dbowner__main_db
go
select sys.user_name(), is_member('db_owner')
go
~~START~~
nvarchar#!#int
dbowner__u1#!#1
~~END~~

select rolname, login_name, default_schema_name, default_language_name from babelfish_authid_user_ext where rolname in ('dbowner__main_db_dbowner__u1', 'dbowner__main_db_new_dbowner__u2') order by rolname
go
~~START~~
varchar#!#varchar#!#nvarchar#!#nvarchar
dbowner__main_db_dbowner__u1#!#dbowner__l1#!#dbowner__s1#!#English
~~END~~

select name from sys.database_principals order by name
go
~~START~~
varchar
db_accessadmin
db_datareader
db_datawriter
db_ddladmin
db_owner
db_securityadmin
dbo
dbowner__r1
dbowner__r2
dbowner__u1
dbowner__u2
guest
INFORMATION_SCHEMA
public
sys
~~END~~


-- tsql user=dbowner__l2 password=123
use dbowner__main_db
go
select is_member('db_owner')
go
~~START~~
int
0
~~END~~

select * from dbo.dbowner__t0
go
~~ERROR (Code: 33557097)~~

~~ERROR (Message: permission denied for table dbowner__t0)~~

select * from dbo.dbowner__v0
go
~~ERROR (Code: 33557097)~~

~~ERROR (Message: permission denied for view dbowner__v0)~~

select next value for dbo.dbowner__seq0;
go
~~START~~
bigint
~~ERROR (Code: 33557097)~~

~~ERROR (Message: permission denied for sequence dbowner__seq0)~~

select dbo.dbowner__f0()
go
~~ERROR (Code: 33557097)~~

~~ERROR (Message: permission denied for function dbowner__f0)~~

exec dbo.dbowner__p0
go
~~ERROR (Code: 33557097)~~

~~ERROR (Message: permission denied for procedure dbowner__p0)~~

select * from dbowner__s1.dbowner__t1
go
~~ERROR (Code: 33557097)~~

~~ERROR (Message: permission denied for table dbowner__t1)~~

select * from dbowner__s1.dbowner__v1
go
~~ERROR (Code: 33557097)~~

~~ERROR (Message: permission denied for view dbowner__v1)~~

select next value for dbowner__s1.dbowner__seq1;
go
~~START~~
bigint
~~ERROR (Code: 33557097)~~

~~ERROR (Message: permission denied for sequence dbowner__seq1)~~

select dbowner__s1.dbowner__f1()
go
~~ERROR (Code: 33557097)~~

~~ERROR (Message: permission denied for function dbowner__f1)~~

exec dbowner__s1.dbowner__p1
go
~~ERROR (Code: 33557097)~~

~~ERROR (Message: permission denied for procedure dbowner__p1)~~

select * from dbowner__s2.dbowner__t2
go
~~START~~
int
12
22
32
~~END~~

select * from dbowner__s2.dbowner__v2
go
~~START~~
int
1
~~END~~

select next value for dbowner__s2.dbowner__seq2;
go
~~START~~
bigint
8
~~END~~

select dbowner__s2.dbowner__f2()
go
~~START~~
int
12
~~END~~

exec dbowner__s2.dbowner__p2
go
~~START~~
int
22
~~END~~

select * from dbowner__s1.dbowner__t11
go
~~ERROR (Code: 33557097)~~

~~ERROR (Message: permission denied for table dbowner__t11)~~

select * from dbowner__s3.dbowner__t3
go
~~ERROR (Code: 33557097)~~

~~ERROR (Message: permission denied for table dbowner__t3)~~

select * from dbowner__s3.dbowner__v3
go
~~ERROR (Code: 33557097)~~

~~ERROR (Message: permission denied for view dbowner__v3)~~

select next value for dbowner__s3.dbowner__seq3;
go
~~START~~
bigint
~~ERROR (Code: 33557097)~~

~~ERROR (Message: permission denied for sequence dbowner__seq3)~~

select dbowner__s3.dbowner__f3()
go
~~ERROR (Code: 33557097)~~

~~ERROR (Message: permission denied for function dbowner__f3)~~

exec dbowner__s3.dbowner__p3
go
~~ERROR (Code: 33557097)~~

~~ERROR (Message: permission denied for procedure dbowner__p3)~~


select name from sys.database_principals order by name
go
~~START~~
varchar
db_accessadmin
db_datareader
db_datawriter
db_ddladmin
db_owner
db_securityadmin
dbo
dbowner__u2
guest
INFORMATION_SCHEMA
public
sys
~~END~~


-- psql
-- Procedure/function owners should be dbowner__main_db_dbowner__u1_obj
SELECT proname,
       proowner::regrole
FROM pg_proc
WHERE pronamespace::regnamespace::text = 'dbowner__main_db_dbowner__s1'
OR pronamespace::regnamespace::text = 'dbowner__main_db_dbowner__s3'
ORDER BY proname;
GO
~~START~~
name#!#regrole
dbowner__f1#!#dbowner__main_db_dbowner__u1_obj
dbowner__f3#!#dbowner__main_db_dbowner__u1_obj
dbowner__p1#!#dbowner__main_db_dbowner__u1_obj
dbowner__p3#!#dbowner__main_db_dbowner__u1_obj
dbowner__trg1#!#dbowner__main_db_dbowner__u1_obj
~~END~~


-- Table owners should be dbowner__main_db_dbowner__u1_obj
SELECT
    n.nspname AS schema,
    c.relname AS table,
    CASE c.relkind
        WHEN 'r' THEN 'table'
        WHEN 'v' THEN 'view'
        WHEN 'm' THEN 'materialized view'
        WHEN 'i' THEN 'index'
        WHEN 'S' THEN 'sequence'
        WHEN 's' THEN 'special'
        WHEN 'f' THEN 'foreign table'
    END AS type,
    pg_catalog.pg_get_userbyid(c.relowner) AS owner
FROM pg_catalog.pg_class c
LEFT JOIN pg_catalog.pg_namespace n ON n.oid = c.relnamespace
WHERE (n.nspname = 'dbowner__main_db_dbowner__s1' OR n.nspname = 'dbowner__main_db_dbowner__s3')
AND c.relkind IN ('r', 'v', 'm', 'i', 'S', 's', 'f')
ORDER BY n.nspname, c.relkind, c.relname;
GO
~~START~~
name#!#name#!#text#!#name
dbowner__main_db_dbowner__s1#!#dbowner__seq1#!#sequence#!#dbowner__main_db_dbowner__u1_obj
dbowner__main_db_dbowner__s1#!#dbowner__idx1dbowner__t1051d92a6c0688536803636483cfc1e78#!#index#!#dbowner__main_db_dbowner__u1_obj
dbowner__main_db_dbowner__s1#!#dbowner__t1#!#table#!#dbowner__main_db_dbowner__u1_obj
dbowner__main_db_dbowner__s1#!#dbowner__t11#!#table#!#dbowner__main_db_dbowner__u1_obj
dbowner__main_db_dbowner__s1#!#dbowner__v1#!#view#!#dbowner__main_db_dbowner__u1_obj
dbowner__main_db_dbowner__s3#!#dbowner__seq3#!#sequence#!#dbowner__main_db_dbowner__u1_obj
dbowner__main_db_dbowner__s3#!#dbowner__t3#!#table#!#dbowner__main_db_dbowner__u1_obj
dbowner__main_db_dbowner__s3#!#dbowner__v3#!#view#!#dbowner__main_db_dbowner__u1_obj
~~END~~


-- Schemas owner should be dbowner__main_db_dbowner__u1_obj except for dbowner__main_db_dbowner__sch_u2
SELECT
    r.rolname AS schema_owner,
    ns.nspname
FROM
    pg_namespace ns
JOIN
    pg_roles r 
ON
    ns.nspowner = r.oid
WHERE
    ns.nspname IN ('dbowner__main_db_dbowner__s1', 'dbowner__main_db_dbowner__s3', 'dbowner__main_db_dbowner__sch_u2')
ORDER BY ns.nspname;
GO
~~START~~
name#!#name
dbowner__main_db_dbowner__u1_obj#!#dbowner__main_db_dbowner__s1
dbowner__main_db_dbowner__u1_obj#!#dbowner__main_db_dbowner__s3
dbowner__main_db_dbowner__u2#!#dbowner__main_db_dbowner__sch_u2
~~END~~


-- tsql
select * from dbo.dbowner__t0
go
~~START~~
int
10
20
30
~~END~~

select * from dbo.dbowner__v0
go
~~START~~
int
1
~~END~~

select next value for dbo.dbowner__seq0;
go
~~START~~
bigint
4
~~END~~

select dbo.dbowner__f0()
go
~~START~~
int
10
~~END~~

exec dbo.dbowner__p0
go
~~START~~
int
20
~~END~~

select * from dbowner__s1.dbowner__t1
go
~~START~~
int
11
21
31
~~END~~

select * from dbowner__s1.dbowner__v1
go
~~START~~
int
1
~~END~~

select next value for dbowner__s1.dbowner__seq1;
go
~~START~~
bigint
6
~~END~~

select dbowner__s1.dbowner__f1()
go
~~START~~
int
11
~~END~~

exec dbowner__s1.dbowner__p1
go
~~START~~
int
21
~~END~~

select * from dbowner__s2.dbowner__t2
go
~~START~~
int
12
22
32
~~END~~

select * from dbowner__s2.dbowner__v2
go
~~START~~
int
1
~~END~~

select next value for dbowner__s2.dbowner__seq2;
go
~~START~~
bigint
12
~~END~~

select dbowner__s2.dbowner__f2()
go
~~START~~
int
12
~~END~~

exec dbowner__s2.dbowner__p2
go
~~START~~
int
22
~~END~~

select * from dbowner__s1.dbowner__t11
go
~~START~~
int
~~END~~

select * from dbowner__s3.dbowner__t3
go
~~START~~
int
~~END~~

select * from dbowner__s3.dbowner__v3
go
~~START~~
int
230
~~END~~

select next value for dbowner__s3.dbowner__seq3;
go
~~START~~
bigint
5
~~END~~

select dbowner__s3.dbowner__f3()
go
~~START~~
int
13
~~END~~

exec dbowner__s3.dbowner__p3
go
~~START~~
int
23
~~END~~

create schema dbowner__sch_u1 authorization dbowner__u1
go

-- Schema owners should be dbowner__main_db_dbowner__u1_obj
SELECT
    r.rolname AS schema_owner,
    ns.nspname
FROM
    pg_namespace ns
JOIN
    pg_roles r 
ON
    ns.nspowner = r.oid
WHERE
    ns.nspname = 'dbowner__main_db_dbowner__sch_u1'
ORDER BY ns.nspname;
GO
~~START~~
varchar#!#varchar
dbowner__main_db_dbowner__u1_obj#!#dbowner__main_db_dbowner__sch_u1
~~END~~


select name from sys.database_principals order by name
go
~~START~~
varchar
db_accessadmin
db_datareader
db_datawriter
db_ddladmin
db_owner
db_securityadmin
dbo
dbowner__r1
dbowner__r2
dbowner__u1
dbowner__u2
guest
INFORMATION_SCHEMA
public
sys
~~END~~


-- CASE 5: If removed from db_owner, user should lose access to objects in schemas except the ones it owns
alter role db_owner drop member dbowner__u1
go

-- psql
-- Before anything, let's check if internal role linking/delinking got reverted as expected
SELECT rolname FROM pg_roles WHERE rolname = 'dbowner__main_db_dbowner__u1_obj'; -- "_obj" role should not exist
go
~~START~~
name
~~END~~



SELECT r.rolname AS parent_role
FROM pg_auth_members m
JOIN pg_roles r ON (m.roleid = r.oid)
JOIN pg_roles mr ON (m.member = mr.oid)
WHERE mr.rolname = 'dbowner__main_db_dbowner__u1'
ORDER BY r.rolname;
go
~~START~~
name
~~END~~


SELECT r.rolname AS parent_role
FROM pg_auth_members m
JOIN pg_roles r ON (m.roleid = r.oid)
JOIN pg_roles mr ON (m.member = mr.oid)
WHERE mr.rolname = 'dbowner__main_db_db_owner'
ORDER BY r.rolname;
go
~~START~~
name
dbowner__main_db_db_accessadmin
dbowner__main_db_db_datareader
dbowner__main_db_db_datawriter
dbowner__main_db_db_ddladmin
dbowner__main_db_db_securityadmin
dbowner__main_db_dbowner__r1
dbowner__main_db_dbowner__r2
dbowner__main_db_dbowner__u1
dbowner__main_db_dbowner__u2
dbowner__main_db_guest
~~END~~


SELECT r.rolname AS parent_role
FROM pg_auth_members m
JOIN pg_roles r ON (m.roleid = r.oid)
JOIN pg_roles mr ON (m.member = mr.oid)
WHERE mr.rolname = 'dbowner__main_db_dbo'
ORDER BY r.rolname;
go
~~START~~
name
dbowner__main_db_db_owner
~~END~~


-- tsql user=dbowner__l1 password=123
select is_member('db_owner')
go
~~START~~
int
0
~~END~~

select * from dbo.dbowner__t0
go
~~ERROR (Code: 33557097)~~

~~ERROR (Message: permission denied for table dbowner__t0)~~

select * from dbo.dbowner__v0
go
~~ERROR (Code: 33557097)~~

~~ERROR (Message: permission denied for view dbowner__v0)~~

select next value for dbo.dbowner__seq0;
go
~~START~~
bigint
~~ERROR (Code: 33557097)~~

~~ERROR (Message: permission denied for sequence dbowner__seq0)~~

select dbo.dbowner__f0()
go
~~ERROR (Code: 33557097)~~

~~ERROR (Message: permission denied for function dbowner__f0)~~

exec dbo.dbowner__p0
go
~~ERROR (Code: 33557097)~~

~~ERROR (Message: permission denied for procedure dbowner__p0)~~

select * from dbowner__s1.dbowner__t1
go
~~START~~
int
11
21
31
~~END~~

select * from dbowner__s1.dbowner__v1
go
~~START~~
int
1
~~END~~

select next value for dbowner__s1.dbowner__seq1;
go
~~START~~
bigint
9
~~END~~

select dbowner__s1.dbowner__f1()
go
~~START~~
int
11
~~END~~

exec dbowner__s1.dbowner__p1
go
~~START~~
int
21
~~END~~

select * from dbowner__s2.dbowner__t2
go
~~ERROR (Code: 33557097)~~

~~ERROR (Message: permission denied for table dbowner__t2)~~

select * from dbowner__s2.dbowner__v2
go
~~ERROR (Code: 33557097)~~

~~ERROR (Message: permission denied for view dbowner__v2)~~

select next value for dbowner__s2.dbowner__seq2;
go
~~START~~
bigint
~~ERROR (Code: 33557097)~~

~~ERROR (Message: permission denied for sequence dbowner__seq2)~~

select dbowner__s2.dbowner__f2()
go
~~ERROR (Code: 33557097)~~

~~ERROR (Message: permission denied for function dbowner__f2)~~

exec dbowner__s2.dbowner__p2
go
~~ERROR (Code: 33557097)~~

~~ERROR (Message: permission denied for procedure dbowner__p2)~~

select * from dbowner__s1.dbowner__t11
go
~~START~~
int
~~END~~

select * from dbowner__s3.dbowner__t3
go
~~START~~
int
~~END~~

select * from dbowner__s3.dbowner__v3
go
~~START~~
int
230
~~END~~

select next value for dbowner__s3.dbowner__seq3;
go
~~START~~
bigint
10
~~END~~

select dbowner__s3.dbowner__f3()
go
~~START~~
int
13
~~END~~

exec dbowner__s3.dbowner__p3
go
~~START~~
int
23
~~END~~


-- CASE 6: If removed from db_owner, user should lose access to create objects in schemas except the ones it owns
alter table dbo.dbowner__t0 add c int
go
~~ERROR (Code: 33557097)~~

~~ERROR (Message: must be owner of table dbowner__t0)~~

alter function dbo.dbowner__f0() returns int as begin return 1345 end
go
~~ERROR (Code: 33557097)~~

~~ERROR (Message: permission denied for schema dbowner__main_db_dbo)~~

alter procedure dbo.dbowner__p0 as select 2345
go
~~ERROR (Code: 33557097)~~

~~ERROR (Message: permission denied for schema dbowner__main_db_dbo)~~

create role dbowner__r3
go
~~ERROR (Code: 33557097)~~

~~ERROR (Message: User does not have permission to perform this action.)~~

create role dbowner__r4
go
~~ERROR (Code: 33557097)~~

~~ERROR (Message: User does not have permission to perform this action.)~~

create user dbowner__temp for login dbowner__temp
go
~~ERROR (Code: 33557097)~~

~~ERROR (Message: User does not have permission to perform this action.)~~

alter role dbowner__r1 add member dbowner__u2
go
~~ERROR (Code: 33557097)~~

~~ERROR (Message: Current login dbowner__l1 does not have permission to alter role dbowner__main_db_dbowner__r1)~~

drop user dbowner__u2
go
~~ERROR (Code: 33557097)~~

~~ERROR (Message: Cannot drop the user 'dbowner__u2', because it does not exist or you do not have permission.)~~

drop role dbowner__r1
go
~~ERROR (Code: 33557097)~~

~~ERROR (Message: Cannot drop the role 'dbowner__r1', because it does not exist or you do not have permission.)~~

drop role dbowner__r2
go
~~ERROR (Code: 33557097)~~

~~ERROR (Message: Cannot drop the role 'dbowner__r2', because it does not exist or you do not have permission.)~~


-- psql
-- Procedure/function owners should be dbowner__main_db_dbowner__u1
SELECT proname,
       proowner::regrole
FROM pg_proc
WHERE pronamespace::regnamespace::text = 'dbowner__main_db_dbowner__s1'
OR pronamespace::regnamespace::text = 'dbowner__main_db_dbowner__s3'
ORDER BY proname;
GO
~~START~~
name#!#regrole
dbowner__f1#!#dbowner__main_db_dbowner__u1
dbowner__f3#!#dbowner__main_db_dbowner__u1
dbowner__p1#!#dbowner__main_db_dbowner__u1
dbowner__p3#!#dbowner__main_db_dbowner__u1
dbowner__trg1#!#dbowner__main_db_dbowner__u1
~~END~~


-- Table owners should be dbowner__main_db_dbowner__u1
SELECT
    n.nspname AS schema,
    c.relname AS table,
    CASE c.relkind
        WHEN 'r' THEN 'table'
        WHEN 'v' THEN 'view'
        WHEN 'm' THEN 'materialized view'
        WHEN 'i' THEN 'index'
        WHEN 'S' THEN 'sequence'
        WHEN 's' THEN 'special'
        WHEN 'f' THEN 'foreign table'
    END AS type,
    pg_catalog.pg_get_userbyid(c.relowner) AS owner
FROM pg_catalog.pg_class c
LEFT JOIN pg_catalog.pg_namespace n ON n.oid = c.relnamespace
WHERE (n.nspname = 'dbowner__main_db_dbowner__s1' OR n.nspname = 'dbowner__main_db_dbowner__s3')
AND c.relkind IN ('r', 'v', 'm', 'i', 'S', 's', 'f')
ORDER BY n.nspname, c.relkind, c.relname;
GO
~~START~~
name#!#name#!#text#!#name
dbowner__main_db_dbowner__s1#!#dbowner__seq1#!#sequence#!#dbowner__main_db_dbowner__u1
dbowner__main_db_dbowner__s1#!#dbowner__idx1dbowner__t1051d92a6c0688536803636483cfc1e78#!#index#!#dbowner__main_db_dbowner__u1
dbowner__main_db_dbowner__s1#!#dbowner__t1#!#table#!#dbowner__main_db_dbowner__u1
dbowner__main_db_dbowner__s1#!#dbowner__t11#!#table#!#dbowner__main_db_dbowner__u1
dbowner__main_db_dbowner__s1#!#dbowner__v1#!#view#!#dbowner__main_db_dbowner__u1
dbowner__main_db_dbowner__s3#!#dbowner__seq3#!#sequence#!#dbowner__main_db_dbowner__u1
dbowner__main_db_dbowner__s3#!#dbowner__t3#!#table#!#dbowner__main_db_dbowner__u1
dbowner__main_db_dbowner__s3#!#dbowner__v3#!#view#!#dbowner__main_db_dbowner__u1
~~END~~


-- Schema owners should be dbowner__main_db_dbowner__u1
SELECT
    r.rolname AS schema_owner,
    ns.nspname
FROM
    pg_namespace ns
JOIN
    pg_roles r 
ON
    ns.nspowner = r.oid
WHERE
    ns.nspname IN ('dbowner__main_db_dbowner__s1', 'dbowner__main_db_dbowner__s3', 'dbowner__main_db_dbowner__sch_u1', 'dbowner__main_db_dbowner__sch_u2')
ORDER BY ns.nspname;
GO
~~START~~
name#!#name
dbowner__main_db_dbowner__u1#!#dbowner__main_db_dbowner__s1
dbowner__main_db_dbowner__u1#!#dbowner__main_db_dbowner__s3
dbowner__main_db_dbowner__u1#!#dbowner__main_db_dbowner__sch_u1
dbowner__main_db_dbowner__u2#!#dbowner__main_db_dbowner__sch_u2
~~END~~


-- tsql
alter role db_owner add member dbowner__u1
go

-- psql
-- Need to terminate active session before cleaning up the login
SELECT pg_terminate_backend(pid) FROM pg_stat_get_activity(NULL) 
WHERE sys.suser_name(usesysid) = 'dbowner__l2' AND backend_type = 'client backend' AND usesysid IS NOT NULL;
GO
~~START~~
bool
t
~~END~~

-- Wait to sync with another session
SELECT pg_sleep(1);
GO
~~START~~
void

~~END~~


-- tsql user=dbowner__l1 password=123
select is_member('db_owner')
go
~~START~~
int
1
~~END~~


-- CASE 6: User member of db_owner should be able to drop all objects in its database
create role dbowner__r3
go
create role dbowner__r4
go
create user dbowner__temp for login dbowner__temp
go
alter role dbowner__r1 add member dbowner__temp
go
alter role dbowner__r3 add member dbowner__temp
go
alter role dbowner__r3 add member dbowner__r1
go
alter role dbowner__r4 add member dbowner__r2
go
drop user dbowner__temp
go
drop role dbowner__r1
go
drop role dbowner__r2
go
drop role dbowner__r3
go
drop role dbowner__r4
go

drop index dbowner__idx0 on dbo.dbowner__t0
go
drop table dbo.dbowner__t0
go
drop function dbo.dbowner__f0
go
drop procedure dbo.dbowner__p0
go
drop type dbo.dbowner__typ0
go
drop view dbo.dbowner__v0
go
drop sequence dbo.dbowner__seq0
go
drop index dbowner__idx1 on dbowner__s1.dbowner__t1
go
drop table dbowner__s1.dbowner__t1
go
drop function dbowner__s1.dbowner__f1
go
drop procedure dbowner__s1.dbowner__p1
go
drop table dbowner__s1.dbowner__t11
go
drop type dbowner__s1.dbowner__typ1
go
drop view dbowner__s1.dbowner__v1
go
drop sequence dbowner__s1.dbowner__seq1
go
drop index dbowner__idx2 on dbowner__s2.dbowner__t2
go
drop table dbowner__s2.dbowner__t2
go
drop function dbowner__s2.dbowner__f2
go
drop procedure dbowner__s2.dbowner__p2
go
drop type dbowner__s2.dbowner__typ2
go
drop view dbowner__s2.dbowner__v2
go
drop sequence dbowner__s2.dbowner__seq2
go
drop table dbowner__s3.dbowner__t3
go
drop function dbowner__s3.dbowner__f3
go
drop procedure dbowner__s3.dbowner__p3
go
drop type dbowner__s3.dbowner__typ3
go
drop view dbowner__s3.dbowner__v3
go
drop sequence dbowner__s3.dbowner__seq3
go
drop index dbowner__idx00 on dbowner__s0.dbowner__t00
go
drop table dbowner__s0.dbowner__t00
go
drop function dbowner__s0.dbowner__f00
go
drop type dbowner__s0.dbowner__typ00
go
drop view dbowner__s0.dbowner__v00
go
drop sequence dbowner__s0.dbowner__seq00
go
drop schema dbowner__s0
go
drop schema dbowner__s1
go
drop schema dbowner__s2
go
drop schema dbowner__s3
go
drop schema dbowner__sch_u1
go
drop schema dbowner__sch_u2
go
drop user dbowner__u2
go

-- tsql
alter role db_owner drop member dbowner__u1
go

-- tsql user=dbowner__l1 password=123
select is_member('db_owner')
go
~~START~~
int
0
~~END~~


-- tsql
-- CASE 7: Check if db_owner can drop the database
create database dbowner__test_db
go
use dbowner__test_db
go
create user dbowner__test_db_dbowner__u1 for login dbowner__l1
go
alter role db_owner add member dbowner__test_db_dbowner__u1
go
use dbowner__main_db
go

-- tsql user=dbowner__l1 password=123
select sys.user_name()
go
~~START~~
nvarchar
dbowner__u1
~~END~~

select is_member('db_owner')
go
~~START~~
int
0
~~END~~

drop database dbowner__test_db
go

-- tsql
-- CASE 8: Check if there can be multiple db_owners
create database dbowner__test_db
go
use dbowner__test_db
go
create user dbowner__test_db_dbowner__u1 for login dbowner__l1
go
alter role db_owner add member dbowner__test_db_dbowner__u1
go

-- tsql user=dbowner__l1 password=123
-- CASE 9: Should be able to add other users to db_owner role as a member of db_owner
use dbowner__test_db
go
select is_member('db_owner')
go
~~START~~
int
1
~~END~~

create user dbowner__test_db_dbowner__u2 for login dbowner__l2
go
alter role db_owner add member dbowner__test_db_dbowner__u2
go
select is_rolemember('db_owner', 'dbowner__test_db_dbowner__u1'), is_rolemember('db_owner', 'dbowner__test_db_dbowner__u2')
go
~~START~~
int#!#int
1#!#1
~~END~~


-- CASE 10: Should be able to drop other users from db_owner role as a member of db_owner, including itself
alter role db_owner drop member dbowner__test_db_dbowner__u2
go
alter role db_owner drop member dbowner__test_db_dbowner__u1
go

-- tsql
alter role db_owner add member dbowner__test_db_dbowner__u1
go
alter role db_owner add member dbowner__test_db_dbowner__u2
go

-- psql
-- Need to terminate active session before cleaning up the login
SELECT pg_terminate_backend(pid) FROM pg_stat_get_activity(NULL) 
WHERE sys.suser_name(usesysid) = 'dbowner__l1' AND backend_type = 'client backend' AND usesysid IS NOT NULL;
GO
~~START~~
bool
t
~~END~~

-- Wait to sync with another session
SELECT pg_sleep(1);
GO
~~START~~
void

~~END~~



-- psql
-- Check if dropping user, also drops the linked "_obj" role
select rolname from pg_authid where rolname like 'dbowner__test_db_%' order by rolname;
go
~~START~~
name
dbowner__test_db_db_accessadmin
dbowner__test_db_db_datareader
dbowner__test_db_db_datawriter
dbowner__test_db_db_ddladmin
dbowner__test_db_db_owner
dbowner__test_db_db_securityadmin
dbowner__test_db_dbo
dbowner__test_db_dbowner__test_db_dbowner__u1
dbowner__test_db_dbowner__test_db_dbowner__u1_obj
dbowner__test_db_dbowner__test_db_dbowner__u2
dbowner__test_db_dbowner__test_db_dbowner__u2_obj
dbowner__test_db_guest
~~END~~


-- tsql
use dbowner__test_db
go
drop user dbowner__test_db_dbowner__u1
go
drop user dbowner__test_db_dbowner__u2
go
use dbowner__main_db
go

-- psql
select rolname from pg_authid where rolname like 'dbowner__test_db_%' order by rolname;
go
~~START~~
name
dbowner__test_db_db_accessadmin
dbowner__test_db_db_datareader
dbowner__test_db_db_datawriter
dbowner__test_db_db_ddladmin
dbowner__test_db_db_owner
dbowner__test_db_db_securityadmin
dbowner__test_db_dbo
dbowner__test_db_guest
~~END~~


-- tsql
-- CASE 11: Check if long database names and long user names work with db_owner role
create database dbowner_averyveryveryveryveryveryveryveryveryveryverylongdatabasename -- 70 characters
go
use dbowner_averyveryveryveryveryveryveryveryveryveryverylongdatabasename
go
create user dbowner_averyveryveryveryveryveryveryveryveryveryverylongusername for login dbowner__temp -- 66 characters
go
alter role db_owner add member dbowner_averyveryveryveryveryveryveryveryveryveryverylongusername
go

-- tsql user=dbowner__temp password=123
use dbowner_averyveryveryveryveryveryveryveryveryveryverylongdatabasename
go
select is_member('db_owner')
go
~~START~~
int
1
~~END~~

create schema db_owner_temp_schema
go
create table dbo.temp_tab (a int)
go
create table db_owner_temp_schema.temp_tab (a int)
go
insert into dbo.temp_tab values (1), (2), (34567)
go
~~ROW COUNT: 3~~

insert into db_owner_temp_schema.temp_tab values (1), (2), (34567)
go
~~ROW COUNT: 3~~

select * from dbo.temp_tab
go
~~START~~
int
1
2
34567
~~END~~

select * from db_owner_temp_schema.temp_tab
go
~~START~~
int
1
2
34567
~~END~~

drop table db_owner_temp_schema.temp_tab
go
drop table dbo.temp_tab
go
drop schema db_owner_temp_schema
go
alter role db_owner drop member dbowner_averyveryveryveryveryveryveryveryveryveryverylongusername
go
select is_member('db_owner')
go
~~START~~
int
0
~~END~~

use master
go

-- tsql
drop user dbowner_averyveryveryveryveryveryveryveryveryveryverylongusername
go
use master
go
drop database dbowner_averyveryveryveryveryveryveryveryveryveryverylongdatabasename
go
